@version: 4.4
@include "scl.conf"

options {
    chain_hostnames(off);
    flush_lines(0);
    use_dns(no);
    use_fqdn(no);
    dns_cache(no);
    keep_hostname(yes);
    stats_freq(0);
};

# Source: Sauron alerts JSON file
source s_sauron {
    file("/var/log/sauron/alerts.jsonl"
        follow-freq(1)
        flags(no-parse)
    );
};

# Template: Add VM name and timestamp
template t_json_envelope {
    template('{"vm":"${VM_NAME}","ts":"${ISODATE}","alert":${MESSAGE}}\n');
};

# Destination: Central syslog-ng server
destination d_central {
    network(
        "`CENTRAL_HOST`"
        port(`CENTRAL_PORT`)
        transport("tcp")
        template(t_json_envelope)
        disk-buffer(
            mem-buf-size(10485760)
            disk-buf-size(104857600)
            reliable(yes)
            dir("/var/cache/syslog-ng")
        )
    );
};

# Destination: Local backup file
destination d_local_backup {
    file("/var/log/sauron/shipped.jsonl"
        template(t_json_envelope)
    );
};

# Log path
log {
    source(s_sauron);
    destination(d_central);
    destination(d_local_backup);
};
