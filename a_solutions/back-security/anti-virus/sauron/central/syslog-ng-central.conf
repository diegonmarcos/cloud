@version: 4.4
@include "scl.conf"

options {
    chain_hostnames(off);
    flush_lines(0);
    use_dns(no);
    use_fqdn(no);
    dns_cache(no);
    keep_hostname(yes);
    stats_freq(0);
    log_fifo_size(10000);
};

# Source: TCP from all VMs
source s_network {
    network(
        ip("0.0.0.0")
        port(5514)
        transport("tcp")
        max-connections(100)
        flags(no-parse)
    );
};

# Parser: JSON
parser p_json {
    json-parser(prefix(".json."));
};

# Destination: JSONL file (queryable with jq/duckdb)
destination d_jsonl {
    file("/var/log/siem/alerts.jsonl"
        template('${MESSAGE}\n')
    );
};

# Destination: SQLite (for structured queries)
destination d_sqlite {
    sql(
        type(sqlite3)
        database("/var/log/siem/alerts.db")
        table("alerts")
        columns("ts", "vm", "severity", "rule", "file", "raw")
        values("${.json.ts}", "${.json.vm}", "${.json.alert.severity}", "${.json.alert.rule}", "${.json.alert.file}", "${MESSAGE}")
        indexes("ts", "vm", "severity")
    );
};

# Destination: Separate file per VM
destination d_per_vm {
    file("/var/log/siem/vms/${.json.vm}.jsonl"
        template('${MESSAGE}\n')
        create-dirs(yes)
    );
};

# Log paths
log {
    source(s_network);
    parser(p_json);
    destination(d_jsonl);
    destination(d_sqlite);
    destination(d_per_vm);
};
