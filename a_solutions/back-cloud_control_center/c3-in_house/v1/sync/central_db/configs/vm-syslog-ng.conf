# =============================================================================
# SYSLOG-NG CONFIGURATION - VM AGENT (SENDER)
# =============================================================================
# Location: /etc/syslog-ng/conf.d/siem.conf
# Purpose: Forward security events to central SIEM
# Version: 1.0.0
# =============================================================================

@version: 4.0

# -----------------------------------------------------------------------------
# OPTIONS
# -----------------------------------------------------------------------------
options {
    chain_hostnames(off);
    keep_hostname(yes);
    use_dns(no);
    use_fqdn(no);
    time_reopen(10);
    log_fifo_size(10000);
    dns_cache(no);
};

# -----------------------------------------------------------------------------
# SOURCES - Local log files
# -----------------------------------------------------------------------------

# Auth logs (SSH, sudo)
source s_auth {
    file("/var/log/auth.log"
        follow-freq(1)
        flags(no-parse)
    );
};

# Kernel/system messages
source s_kern {
    file("/var/log/kern.log"
        follow-freq(1)
        flags(no-parse)
    );
};

# UFW firewall logs
source s_ufw {
    file("/var/log/ufw.log"
        follow-freq(1)
        flags(no-parse)
    );
};

# Sauron security alerts (if installed)
source s_sauron {
    file("/var/log/sauron/alerts.jsonl"
        follow-freq(1)
        flags(no-parse)
    );
};

# YARA matches (if installed)
source s_yara {
    file("/var/log/sauron/yara.jsonl"
        follow-freq(1)
        flags(no-parse)
    );
};

# Docker events
source s_docker {
    file("/var/log/docker.log"
        follow-freq(1)
        flags(no-parse)
    );
};

# -----------------------------------------------------------------------------
# PARSERS
# -----------------------------------------------------------------------------

# Parse JSON from Sauron/YARA
parser p_json {
    json-parser(prefix(".json."));
};

# -----------------------------------------------------------------------------
# REWRITES - Add metadata
# -----------------------------------------------------------------------------

# Add VM identifier to all messages
rewrite r_add_vm {
    set("${env.SIEM_VM_ID:-unknown}" value(".siem.vm_id"));
    set("${env.SIEM_CATEGORY:-system}" value(".siem.category"));
};

# Categorize by source
rewrite r_cat_auth {
    set("auth" value(".siem.category"));
};

rewrite r_cat_firewall {
    set("firewall" value(".siem.category"));
};

rewrite r_cat_docker {
    set("docker" value(".siem.category"));
};

rewrite r_cat_security {
    set("security" value(".siem.category"));
};

# -----------------------------------------------------------------------------
# FILTERS
# -----------------------------------------------------------------------------

# Filter SSH events
filter f_ssh {
    program("sshd");
};

# Filter sudo events
filter f_sudo {
    program("sudo");
};

# Filter failed auth
filter f_auth_fail {
    match("Failed" value("MESSAGE"))
    or match("failure" value("MESSAGE"))
    or match("FAILED" value("MESSAGE"));
};

# Filter UFW blocks
filter f_ufw_block {
    match("UFW BLOCK" value("MESSAGE"));
};

# -----------------------------------------------------------------------------
# DESTINATIONS
# -----------------------------------------------------------------------------

# Central SIEM server (TCP)
destination d_central_tcp {
    tcp("${env.SIEM_CENTRAL_HOST:-central.internal}"
        port(5514)
        template("$(format-json
            --scope rfc5424
            --scope dot-nv-pairs
            --exclude MESSAGE
            --key ISODATE
            --key HOST
            --key PROGRAM
            --key MSG
            @timestamp=${ISODATE}
            vm_id=${.siem.vm_id}
            category=${.siem.category}
            host=${HOST}
            program=${PROGRAM}
            message=${MSG}
        )\n")
        keep-alive(yes)
        so-keepalive(yes)
    );
};

# Central SIEM server with TLS (production)
destination d_central_tls {
    tcp("${env.SIEM_CENTRAL_HOST:-central.internal}"
        port(5515)
        tls(
            ca-file("/etc/siem/certs/ca.pem")
            cert-file("/etc/siem/certs/client.pem")
            key-file("/etc/siem/certs/client.key")
        )
        template("$(format-json
            --scope rfc5424
            --scope dot-nv-pairs
            --key ISODATE
            @timestamp=${ISODATE}
            vm_id=${.siem.vm_id}
            category=${.siem.category}
        )\n")
    );
};

# Local fallback (when central unreachable)
destination d_local_fallback {
    file("/var/log/siem_fallback.jsonl"
        template("$(format-json
            @timestamp=${ISODATE}
            vm_id=${.siem.vm_id}
            category=${.siem.category}
            message=${MSG}
        )\n")
    );
};

# Local SQLite backup
destination d_local_sqlite {
    sql(
        type(sqlite3)
        database("/var/lib/siem_agent/local_cache.db")
        table("events")
        columns("timestamp", "vm_id", "category", "program", "message")
        values("${ISODATE}", "${.siem.vm_id}", "${.siem.category}", "${PROGRAM}", "${MSG}")
    );
};

# -----------------------------------------------------------------------------
# LOG PATHS
# -----------------------------------------------------------------------------

# Auth logs -> Central
log {
    source(s_auth);
    rewrite(r_add_vm);
    rewrite(r_cat_auth);
    destination(d_central_tcp);
    destination(d_local_sqlite);
    flags(flow-control);
};

# UFW logs -> Central
log {
    source(s_ufw);
    filter(f_ufw_block);
    rewrite(r_add_vm);
    rewrite(r_cat_firewall);
    destination(d_central_tcp);
    flags(flow-control);
};

# Docker logs -> Central
log {
    source(s_docker);
    rewrite(r_add_vm);
    rewrite(r_cat_docker);
    destination(d_central_tcp);
    flags(flow-control);
};

# Sauron alerts -> Central (if source exists)
log {
    source(s_sauron);
    parser(p_json);
    rewrite(r_add_vm);
    rewrite(r_cat_security);
    destination(d_central_tcp);
    flags(flow-control);
};

# YARA matches -> Central (if source exists)
log {
    source(s_yara);
    parser(p_json);
    rewrite(r_add_vm);
    rewrite(r_cat_security);
    destination(d_central_tcp);
    flags(flow-control);
};
