# =============================================================================
# SYSLOG-NG CONFIGURATION - CENTRAL SIEM SERVER (RECEIVER)
# =============================================================================
# Location: /etc/syslog-ng/syslog-ng.conf
# Purpose: Receive and store security events from all VMs
# Version: 1.0.0
# =============================================================================

@version: 4.0
@include "scl.conf"

# -----------------------------------------------------------------------------
# OPTIONS
# -----------------------------------------------------------------------------
options {
    chain_hostnames(off);
    keep_hostname(yes);
    use_dns(no);
    use_fqdn(no);
    stats(freq(3600));
    log_fifo_size(100000);
    time_reopen(10);

    # Performance tuning
    threaded(yes);
    flush_lines(100);
    log_msg_size(65536);
};

# -----------------------------------------------------------------------------
# SOURCES - Receive from VMs
# -----------------------------------------------------------------------------

# TCP receiver (no TLS - for internal network)
source s_network_tcp {
    tcp(
        ip("0.0.0.0")
        port(5514)
        max-connections(100)
        log-iw-size(10000)
        flags(no-parse)
    );
};

# TCP receiver with TLS (production)
source s_network_tls {
    tcp(
        ip("0.0.0.0")
        port(5515)
        max-connections(100)
        tls(
            cert-file("/etc/siem/certs/server.pem")
            key-file("/etc/siem/certs/server.key")
            ca-file("/etc/siem/certs/ca.pem")
            peer-verify(required-trusted)
        )
        flags(no-parse)
    );
};

# UDP receiver (for legacy/syslog compat)
source s_network_udp {
    udp(
        ip("0.0.0.0")
        port(5514)
    );
};

# -----------------------------------------------------------------------------
# PARSERS
# -----------------------------------------------------------------------------

# Parse incoming JSON
parser p_json {
    json-parser(
        prefix(".json.")
        marker("")
    );
};

# Extract timestamp
parser p_timestamp {
    date-parser(
        format("%Y-%m-%dT%H:%M:%S%z")
        template("${.json.@timestamp}")
    );
};

# -----------------------------------------------------------------------------
# FILTERS
# -----------------------------------------------------------------------------

# Filter by category
filter f_auth {
    "${.json.category}" eq "auth";
};

filter f_firewall {
    "${.json.category}" eq "firewall";
};

filter f_docker {
    "${.json.category}" eq "docker";
};

filter f_security {
    "${.json.category}" eq "security";
};

filter f_heartbeat {
    "${.json.category}" eq "heartbeat";
};

# Filter by severity
filter f_critical {
    "${.json.severity}" eq "critical"
    or "${.json.severity}" eq "alert"
    or "${.json.severity}" eq "emergency";
};

filter f_warning_plus {
    "${.json.severity}" eq "warning"
    or "${.json.severity}" eq "error"
    or "${.json.severity}" eq "critical"
    or "${.json.severity}" eq "alert"
    or "${.json.severity}" eq "emergency";
};

# Filter by VM
filter f_vm_oci_micro1 { "${.json.vm_id}" eq "oci-f-micro_1"; };
filter f_vm_oci_micro2 { "${.json.vm_id}" eq "oci-f-micro_2"; };
filter f_vm_gcp_micro1 { "${.json.vm_id}" eq "gcp-f-micro_1"; };
filter f_vm_oci_flex1  { "${.json.vm_id}" eq "oci-p-flex_1"; };

# -----------------------------------------------------------------------------
# DESTINATIONS - SQLite Database
# -----------------------------------------------------------------------------

# Main alerts table
destination d_sqlite_alerts {
    sql(
        type(sqlite3)
        database("/var/siem/security.db")
        table("alerts")
        columns(
            "timestamp",
            "received_at",
            "vm_id",
            "severity",
            "category",
            "source",
            "rule",
            "file_path",
            "file_hash",
            "message",
            "raw_json"
        )
        values(
            "${.json.@timestamp:-${ISODATE}}",
            "$(strftime %Y-%m-%dT%H:%M:%SZ)",
            "${.json.vm_id:-unknown}",
            "${.json.severity:-info}",
            "${.json.category:-system}",
            "${.json.source:-${PROGRAM}}",
            "${.json.rule:-}",
            "${.json.file_path:-}",
            "${.json.file_hash:-}",
            "${.json.message:-${MSG}}",
            "${MSG}"
        )
    );
};

# Auth events table
destination d_sqlite_auth {
    sql(
        type(sqlite3)
        database("/var/siem/security.db")
        table("auth_events")
        columns(
            "timestamp",
            "received_at",
            "vm_id",
            "event_type",
            "username",
            "source_ip",
            "source_port",
            "success",
            "method",
            "session_id",
            "message",
            "raw_json"
        )
        values(
            "${.json.@timestamp:-${ISODATE}}",
            "$(strftime %Y-%m-%dT%H:%M:%SZ)",
            "${.json.vm_id:-unknown}",
            "${.json.event_type:-unknown}",
            "${.json.username:-}",
            "${.json.source_ip:-}",
            "${.json.source_port:-0}",
            "${.json.success:-0}",
            "${.json.method:-}",
            "${.json.session_id:-}",
            "${.json.message:-${MSG}}",
            "${MSG}"
        )
    );
};

# Firewall events table
destination d_sqlite_firewall {
    sql(
        type(sqlite3)
        database("/var/siem/security.db")
        table("firewall_events")
        columns(
            "timestamp",
            "received_at",
            "vm_id",
            "action",
            "protocol",
            "src_ip",
            "src_port",
            "dst_ip",
            "dst_port",
            "interface",
            "raw_json"
        )
        values(
            "${.json.@timestamp:-${ISODATE}}",
            "$(strftime %Y-%m-%dT%H:%M:%SZ)",
            "${.json.vm_id:-unknown}",
            "${.json.action:-UNKNOWN}",
            "${.json.protocol:-}",
            "${.json.src_ip:-}",
            "${.json.src_port:-0}",
            "${.json.dst_ip:-}",
            "${.json.dst_port:-0}",
            "${.json.interface:-}",
            "${MSG}"
        )
    );
};

# Docker events table
destination d_sqlite_docker {
    sql(
        type(sqlite3)
        database("/var/siem/security.db")
        table("docker_events")
        columns(
            "timestamp",
            "received_at",
            "vm_id",
            "event_type",
            "container_id",
            "container_name",
            "image",
            "exit_code",
            "raw_json"
        )
        values(
            "${.json.@timestamp:-${ISODATE}}",
            "$(strftime %Y-%m-%dT%H:%M:%SZ)",
            "${.json.vm_id:-unknown}",
            "${.json.event_type:-unknown}",
            "${.json.container_id:-}",
            "${.json.container_name:-}",
            "${.json.image:-}",
            "${.json.exit_code:-0}",
            "${MSG}"
        )
    );
};

# Heartbeats table
destination d_sqlite_heartbeat {
    sql(
        type(sqlite3)
        database("/var/siem/security.db")
        table("heartbeats")
        columns(
            "timestamp",
            "vm_id",
            "agent_version",
            "uptime_seconds",
            "load_avg",
            "memory_used_mb",
            "memory_total_mb",
            "disk_used_gb",
            "disk_total_gb",
            "docker_containers"
        )
        values(
            "${.json.timestamp:-${ISODATE}}",
            "${.json.vm_id:-unknown}",
            "${.json.agent_version:-unknown}",
            "${.json.uptime_seconds:-0}",
            "${.json.load_avg:-0}",
            "${.json.memory_used_mb:-0}",
            "${.json.memory_total_mb:-0}",
            "${.json.disk_used_gb:-0}",
            "${.json.disk_total_gb:-0}",
            "${.json.docker_containers:-0}"
        )
    );
};

# -----------------------------------------------------------------------------
# DESTINATIONS - File Backups
# -----------------------------------------------------------------------------

# Raw JSON log (all events)
destination d_jsonl_all {
    file("/var/siem/logs/all_events.jsonl"
        template("${MSG}\n")
        create-dirs(yes)
    );
};

# Critical alerts only
destination d_jsonl_critical {
    file("/var/siem/logs/critical.jsonl"
        template("${MSG}\n")
        create-dirs(yes)
    );
};

# Per-VM logs
destination d_jsonl_vm {
    file("/var/siem/logs/by_vm/${.json.vm_id:-unknown}.jsonl"
        template("${MSG}\n")
        create-dirs(yes)
    );
};

# Per-category logs
destination d_jsonl_category {
    file("/var/siem/logs/by_category/${.json.category:-unknown}.jsonl"
        template("${MSG}\n")
        create-dirs(yes)
    );
};

# Daily rotating log
destination d_daily_log {
    file("/var/siem/logs/daily/siem_${YEAR}${MONTH}${DAY}.jsonl"
        template("${MSG}\n")
        create-dirs(yes)
    );
};

# -----------------------------------------------------------------------------
# LOG PATHS
# -----------------------------------------------------------------------------

# All events -> Parse JSON first
log {
    source(s_network_tcp);
    source(s_network_tls);
    parser(p_json);

    # Store raw backup
    destination(d_jsonl_all);
    destination(d_daily_log);
    destination(d_jsonl_vm);
    destination(d_jsonl_category);

    flags(flow-control);
};

# Route to appropriate tables based on category
log {
    source(s_network_tcp);
    source(s_network_tls);
    parser(p_json);
    filter(f_auth);
    destination(d_sqlite_auth);
    flags(flow-control);
};

log {
    source(s_network_tcp);
    source(s_network_tls);
    parser(p_json);
    filter(f_firewall);
    destination(d_sqlite_firewall);
    flags(flow-control);
};

log {
    source(s_network_tcp);
    source(s_network_tls);
    parser(p_json);
    filter(f_docker);
    destination(d_sqlite_docker);
    flags(flow-control);
};

log {
    source(s_network_tcp);
    source(s_network_tls);
    parser(p_json);
    filter(f_heartbeat);
    destination(d_sqlite_heartbeat);
    flags(flow-control);
};

# Security alerts and everything else -> alerts table
log {
    source(s_network_tcp);
    source(s_network_tls);
    parser(p_json);
    filter(f_security);
    destination(d_sqlite_alerts);
    flags(flow-control);
};

# Critical events -> separate file for monitoring
log {
    source(s_network_tcp);
    source(s_network_tls);
    parser(p_json);
    filter(f_critical);
    destination(d_jsonl_critical);
    flags(flow-control);
};
